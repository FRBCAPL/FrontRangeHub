<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dues Tracker - Account Approval</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background: #1a1d29;
            color: #e2e8f0;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
        }
        .card {
            background: #252936;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
        }
        .card-header {
            background: #2d3142;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .table {
            color: #e2e8f0;
        }
        .table thead {
            background: #2d3142;
        }
        .table tbody tr {
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        .table tbody tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        .badge {
            padding: 0.5em 0.75em;
        }
        .btn-approve {
            background: #10b981;
            border-color: #10b981;
        }
        .btn-approve:hover {
            background: #059669;
            border-color: #059669;
        }
        .btn-reject {
            background: #ef4444;
            border-color: #ef4444;
        }
        .btn-reject:hover {
            background: #dc2626;
            border-color: #dc2626;
        }
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #94a3b8;
        }
        .empty-state i {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <a href="index.html" class="btn btn-outline-secondary btn-sm" title="Back to Dues Tracker">
                <i class="fas fa-arrow-left me-1"></i> Back to Main
            </a>
            <button class="btn btn-outline-light btn-sm" onclick="loadAllAdminData()">
                <i class="fas fa-sync-alt me-1"></i> Refresh All
            </button>
        </div>

        <!-- Current Users Section -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h4 class="mb-0">
                    <i class="fas fa-users me-2"></i> Current Users
                </h4>
            </div>
            <div class="card-body">
                <div id="current-users-loading" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2 text-muted mb-0">Loading users...</p>
                </div>
                <div id="current-users-table-wrap" style="display: none;">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Organization</th>
                                    <th>Divisions</th>
                                    <th>Teams</th>
                                    <th>Players</th>
                                    <th>Subscription</th>
                                    <th>Last Login</th>
                                    <th>Registered</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="current-users-tbody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pending Approvals Section -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h4 class="mb-0">
                    <i class="fas fa-user-check me-2"></i>
                    Pending Account Approvals
                </h4>
            </div>
            <div class="card-body">
                <div id="loading" class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3 text-muted">Loading pending accounts...</p>
                </div>
                
                <div id="empty-state" class="empty-state" style="display: none;">
                    <i class="fas fa-check-circle"></i>
                    <h4>No Pending Accounts</h4>
                    <p>All accounts have been reviewed.</p>
                </div>
                
                <div id="accounts-table" style="display: none;">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Organization</th>
                                    <th>Phone</th>
                                    <th>Registered</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="accounts-tbody">
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div id="error-message" class="alert alert-danger" style="display: none;"></div>
            </div>
        </div>
    </div>

    <!-- Reject Modal -->
    <div class="modal fade" id="rejectModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content" style="background: #252936; color: #e2e8f0;">
                <div class="modal-header" style="border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                    <h5 class="modal-title">Reject Account</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to reject this account?</p>
                    <div class="mb-3">
                        <label for="rejectionReason" class="form-label">Reason (optional):</label>
                        <textarea class="form-control" id="rejectionReason" rows="3" style="background: #1a1d29; color: #e2e8f0; border: 1px solid rgba(255, 255, 255, 0.1);"></textarea>
                    </div>
                </div>
                <div class="modal-footer" style="border-top: 1px solid rgba(255, 255, 255, 0.1);">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-reject" onclick="confirmReject()">Reject Account</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Must match app.js: use Render backend in production (frontend and API are on different hosts)
        const API_BASE_URL = window.location.hostname === 'localhost'
            ? 'http://localhost:8080/api'
            : 'https://atlasbackend-bnng.onrender.com/api';
        
        let currentRejectId = null;
        const rejectModal = new bootstrap.Modal(document.getElementById('rejectModal'));
        
        // Base-path-aware URL for main app (same directory as admin.html)
        function getMainAppUrl() {
            const base = window.location.pathname.replace(/\/[^/]*$/, '') || '/dues-tracker';
            return window.location.origin + base + '/index.html';
        }
        
        // Get auth token from localStorage (set when user logs in)
        function getAuthToken() {
            return localStorage.getItem('authToken');
        }
        
        // Check if user is logged in
        function checkAuth() {
            const token = getAuthToken();
            if (!token) {
                alert('Please log in to access the admin panel.');
                window.location.href = getMainAppUrl();
                return false;
            }
            return true;
        }
        
        // Add auth header to fetch requests
        async function fetchWithAuth(url, options = {}) {
            const token = getAuthToken();
            if (!token) {
                throw new Error('Not authenticated');
            }
            
            const headers = {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`,
                ...options.headers
            };
            
            return fetch(url, { ...options, headers });
        }

        async function loadCurrentUsers() {
            const loading = document.getElementById('current-users-loading');
            const tableWrap = document.getElementById('current-users-table-wrap');
            const tbody = document.getElementById('current-users-tbody');

            loading.style.display = 'block';
            tableWrap.style.display = 'none';

            try {
                const response = await fetchWithAuth(`${API_BASE_URL}/dues-tracker/admin/current-users`);
                if (!response.ok) throw new Error(`Server error: ${response.status}`);
                const users = await response.json();

                loading.style.display = 'none';
                tableWrap.style.display = 'block';
                tbody.innerHTML = '';

                if (users.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="10" class="text-center text-muted py-4">No approved users yet.</td></tr>';
                } else {
                    users.forEach(u => {
                        const row = document.createElement('tr');
                        const regDate = u.created_at ? new Date(u.created_at).toLocaleDateString() : '-';
                        const tier = (u.subscription_tier || 'free').replace(/^./, c => c.toUpperCase());
                        const tierBadge = u.subscription_tier === 'free' ? 'bg-secondary' : (u.subscription_tier === 'enterprise' ? 'bg-info' : 'bg-primary');
                        const lastLogin = u.last_login ? new Date(u.last_login).toLocaleString() : '-';
                        row.innerHTML = `
                            <td>${u.name || '-'}${u.is_admin ? ' <span class="badge bg-warning text-dark ms-1">Admin</span>' : ''}</td>
                            <td>${u.email}</td>
                            <td>${u.organization_name}</td>
                            <td>${u.divisions}</td>
                            <td>${u.teams}</td>
                            <td>${u.players}</td>
                            <td><span class="badge ${tierBadge}">${tier}</span></td>
                            <td>${lastLogin}</td>
                            <td>${regDate}</td>
                            <td><button class="btn btn-sm btn-outline-info" data-operator-id="${u.id}" data-operator-email="${(u.email || '').replace(/"/g, '&quot;')}" onclick="sendApprovalNotification(this)" title="Send approval/login email to this user"><i class="fas fa-envelope me-1"></i>Notify</button></td>
                        `;
                        tbody.appendChild(row);
                    });
                }
            } catch (err) {
                console.error('Error loading current users:', err);
                loading.style.display = 'none';
                if (err.message === 'Not authenticated') {
                    alert('Please log in to access the admin panel.');
                    window.location.href = getMainAppUrl();
                } else {
                    tbody.innerHTML = `<tr><td colspan="10" class="text-center text-danger">Error: ${err.message}</td></tr>`;
                    tableWrap.style.display = 'block';
                }
            }
        }

        function loadAllAdminData() {
            loadCurrentUsers();
            loadPendingAccounts();
        }

        async function sendApprovalNotification(btn) {
            const operatorId = btn.dataset.operatorId;
            const email = btn.dataset.operatorEmail || 'this user';
            if (!checkAuth()) return;
            if (!confirm(`Send approval/login email to ${email}?`)) return;
            try {
                const response = await fetchWithAuth(`${API_BASE_URL}/dues-tracker/admin/send-approval-notification/${operatorId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: '{}'
                });
                const data = await response.json().catch(() => ({}));
                if (response.ok && data.success) {
                    alert('Approval email sent successfully!');
                } else {
                    alert(data.message || 'Failed to send email. Check backend logs.');
                }
            } catch (err) {
                console.error(err);
                alert('Error: ' + (err.message || 'Could not send email'));
            }
        }

        async function loadPendingAccounts() {
            if (!checkAuth()) return;
            
            const loading = document.getElementById('loading');
            const emptyState = document.getElementById('empty-state');
            const accountsTable = document.getElementById('accounts-table');
            const errorMessage = document.getElementById('error-message');
            const tbody = document.getElementById('accounts-tbody');
            
            loading.style.display = 'block';
            emptyState.style.display = 'none';
            accountsTable.style.display = 'none';
            errorMessage.style.display = 'none';
            
            try {
                const response = await fetchWithAuth(`${API_BASE_URL}/dues-tracker/admin/pending-accounts`);
                
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }
                
                const accounts = await response.json();
                
                loading.style.display = 'none';
                
                if (accounts.length === 0) {
                    emptyState.style.display = 'block';
                } else {
                    accountsTable.style.display = 'block';
                    tbody.innerHTML = '';
                    
                    accounts.forEach(account => {
                        const row = document.createElement('tr');
                        const registeredDate = new Date(account.created_at).toLocaleDateString();
                        
                        row.innerHTML = `
                            <td>${account.name || 'N/A'}</td>
                            <td>${account.email}</td>
                            <td>${account.organization_name || '-'}</td>
                            <td>${account.phone || '-'}</td>
                            <td>${registeredDate}</td>
                            <td>
                                <span class="badge bg-warning text-dark">Pending</span>
                            </td>
                            <td>
                                <button class="btn btn-approve btn-sm me-2" onclick="approveAccount('${account.id}', '${account.email}')">
                                    <i class="fas fa-check me-1"></i> Approve
                                </button>
                                <button class="btn btn-reject btn-sm" onclick="showRejectModal('${account.id}', '${account.email}')">
                                    <i class="fas fa-times me-1"></i> Reject
                                </button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                }
            } catch (error) {
                console.error('Error loading pending accounts:', error);
                loading.style.display = 'none';
                if (error.message === 'Not authenticated') {
                    alert('Please log in to access the admin panel.');
                    window.location.href = getMainAppUrl();
                    return;
                }
                errorMessage.textContent = `Error: ${error.message}`;
                errorMessage.style.display = 'block';
            }
        }
        
        async function approveAccount(id, email) {
            if (!checkAuth()) return;
            
            if (!confirm(`Approve account for ${email}?`)) {
                return;
            }
            
            try {
                const response = await fetchWithAuth(`${API_BASE_URL}/dues-tracker/admin/approve-account/${id}`, {
                    method: 'POST',
                    body: JSON.stringify({})
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    if (response.status === 401 || response.status === 403) {
                        alert(error.message || 'You do not have permission to perform this action.');
                        window.location.href = getMainAppUrl();
                        return;
                    }
                    throw new Error(error.message || 'Failed to approve account');
                }
                
                alert('Account approved successfully!');
                loadPendingAccounts();
            } catch (error) {
                console.error('Error approving account:', error);
                if (error.message === 'Not authenticated') {
                    alert('Please log in to access the admin panel.');
                    window.location.href = getMainAppUrl();
                    return;
                }
                alert(`Error: ${error.message}`);
            }
        }
        
        function showRejectModal(id, email) {
            currentRejectId = id;
            document.getElementById('rejectionReason').value = '';
            rejectModal.show();
        }
        
        async function confirmReject() {
            if (!checkAuth()) return;
            if (!currentRejectId) return;
            
            const reason = document.getElementById('rejectionReason').value;
            
            try {
                const response = await fetchWithAuth(`${API_BASE_URL}/dues-tracker/admin/reject-account/${currentRejectId}`, {
                    method: 'POST',
                    body: JSON.stringify({
                        rejectionReason: reason || 'Account rejected by administrator'
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    if (response.status === 401 || response.status === 403) {
                        alert(error.message || 'You do not have permission to perform this action.');
                        window.location.href = getMainAppUrl();
                        return;
                    }
                    throw new Error(error.message || 'Failed to reject account');
                }
                
                rejectModal.hide();
                alert('Account rejected.');
                loadPendingAccounts();
            } catch (error) {
                console.error('Error rejecting account:', error);
                if (error.message === 'Not authenticated') {
                    alert('Please log in to access the admin panel.');
                    window.location.href = getMainAppUrl();
                    return;
                }
                alert(`Error: ${error.message}`);
            }
        }
        
        // Check auth on page load
        if (!checkAuth()) {
            // Redirect will happen in checkAuth
        } else {
            loadAllAdminData();
        }
        
        // Auto-refresh every 30 seconds
        setInterval(loadAllAdminData, 30000);
    </script>
</body>
</html>
